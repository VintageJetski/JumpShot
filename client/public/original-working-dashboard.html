<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Analytics Platform - Advanced Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 28px; font-weight: bold; color: #111827; }
        .subtitle { color: #6b7280; font-size: 14px; margin-top: 4px; }
        .nav { display: flex; gap: 20px; }
        .nav button { background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .nav button:hover { background: #1d4ed8; }
        .nav button.active { background: #1e40af; }
        .grid { display: grid; gap: 20px; margin-bottom: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .card { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h2 { color: #111827; margin-bottom: 16px; font-size: 18px; }
        .card h3 { color: #374151; margin-bottom: 12px; font-size: 16px; }
        .stat-card { text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; margin-bottom: 8px; }
        .stat-label { color: #6b7280; font-size: 14px; }
        .player-list { max-height: 400px; overflow-y: auto; }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f3f4f6; }
        .player-info { flex: 1; }
        .player-name { font-weight: 600; color: #111827; }
        .player-details { font-size: 12px; color: #6b7280; margin-top: 2px; }
        .player-score { text-align: right; font-weight: 600; }
        .piv { color: #2563eb; font-size: 14px; }
        .tir { color: #059669; font-size: 14px; }
        .role-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; margin-left: 4px; }
        .role-awper { background: #dbeafe; color: #1e40af; }
        .role-entry { background: #fecaca; color: #dc2626; }
        .role-support { background: #d1fae5; color: #065f46; }
        .role-lurker { background: #e9d5ff; color: #7c2d12; }
        .role-igl { background: #fef3c7; color: #92400e; }
        .chart-container { height: 300px; position: relative; }
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top: 3px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-bar { background: white; padding: 16px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 14px; font-weight: 500; color: #374151; }
        .filter-group select { padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; }
        .comparison-panel { display: none; }
        .comparison-panel.active { display: block; }
        .vs-indicator { text-align: center; font-size: 24px; font-weight: bold; color: #6b7280; padding: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <div class="title">CS2 Analytics Platform</div>
                <div class="subtitle">Advanced Tournament Analysis - IEM Katowice 2025</div>
            </div>
            <div class="nav">
                <button onclick="showView('dashboard')" class="active" id="btn-dashboard">Dashboard</button>
                <button onclick="showView('players')" id="btn-players">Players</button>
                <button onclick="showView('teams')" id="btn-teams">Teams</button>
                <button onclick="showView('analytics')" id="btn-analytics">Analytics</button>
                <button onclick="showView('comparison')" id="btn-comparison">Compare</button>
                <button onclick="showView('prediction')" id="btn-prediction">Predictions</button>
            </div>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>Loading Advanced CS2 Analytics...</div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden">
            <div class="grid grid-4" id="stats-overview"></div>
            <div class="grid grid-2">
                <div class="card">
                    <h2>PIV Distribution Chart</h2>
                    <div class="chart-container">
                        <canvas id="pivChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Team Performance Radar</h2>
                    <div class="chart-container">
                        <canvas id="teamRadarChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="grid grid-3">
                <div class="card">
                    <h2>Top Players by PIV</h2>
                    <div id="top-players-dashboard" class="player-list"></div>
                </div>
                <div class="card">
                    <h2>Top Teams by TIR</h2>
                    <div id="top-teams-dashboard" class="player-list"></div>
                </div>
                <div class="card">
                    <h2>Role Performance Matrix</h2>
                    <div id="role-matrix"></div>
                </div>
            </div>
        </div>

        <!-- Players View -->
        <div id="players-view" class="hidden">
            <div class="filter-bar">
                <div class="filter-group">
                    <label>Team:</label>
                    <select id="team-filter">
                        <option value="">All Teams</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Role:</label>
                    <select id="role-filter">
                        <option value="">All Roles</option>
                        <option value="AWPer">AWPer</option>
                        <option value="Entry Fragger">Entry Fragger</option>
                        <option value="Support">Support</option>
                        <option value="Lurker">Lurker</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sort by:</label>
                    <select id="sort-filter">
                        <option value="piv">PIV Score</option>
                        <option value="kd">K/D Ratio</option>
                        <option value="name">Name</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-3" id="players-grid"></div>
        </div>

        <!-- Teams View -->
        <div id="teams-view" class="hidden">
            <div class="grid grid-2" id="teams-grid"></div>
        </div>

        <!-- Analytics View -->
        <div id="analytics-view" class="hidden">
            <div class="grid grid-2">
                <div class="card">
                    <h2>Performance Trends</h2>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Role Distribution Analysis</h2>
                    <div class="chart-container">
                        <canvas id="roleChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="grid grid-3">
                <div class="card">
                    <h2>Statistical Insights</h2>
                    <div id="insights-panel"></div>
                </div>
                <div class="card">
                    <h2>Advanced Metrics</h2>
                    <div id="advanced-metrics"></div>
                </div>
                <div class="card">
                    <h2>Performance Outliers</h2>
                    <div id="outliers-analysis"></div>
                </div>
            </div>
        </div>

        <!-- Comparison View -->
        <div id="comparison-view" class="hidden">
            <div class="filter-bar">
                <div class="filter-group">
                    <label>Player 1:</label>
                    <select id="player1-select"></select>
                </div>
                <div class="vs-indicator">VS</div>
                <div class="filter-group">
                    <label>Player 2:</label>
                    <select id="player2-select"></select>
                </div>
                <button onclick="comparePlayers()" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px;">Compare</button>
            </div>
            <div id="comparison-results" class="grid grid-2"></div>
        </div>

        <!-- Prediction View -->
        <div id="prediction-view" class="hidden">
            <div class="card">
                <h2>Match Prediction Engine</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Advanced predictive analytics based on PIV scores, team chemistry, and historical performance.</p>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Team A:</label>
                        <select id="teamA-select"></select>
                    </div>
                    <div class="vs-indicator">VS</div>
                    <div class="filter-group">
                        <label>Team B:</label>
                        <select id="teamB-select"></select>
                    </div>
                    <button onclick="predictMatch()" style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 4px;">Predict Match</button>
                </div>
                <div id="prediction-results"></div>
            </div>
        </div>
    </div>

    <script>
        let playersData = [];
        let teamsData = [];
        let charts = {};

        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(view => view.classList.add('hidden'));
            // Remove active class from all buttons
            document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
            
            // Show selected view
            document.getElementById(viewName + '-view').classList.remove('hidden');
            document.getElementById('btn-' + viewName).classList.add('active');
            
            // Render view-specific content
            switch(viewName) {
                case 'dashboard': renderDashboard(); break;
                case 'players': renderPlayersView(); break;
                case 'teams': renderTeamsView(); break;
                case 'analytics': renderAnalyticsView(); break;
                case 'comparison': renderComparisonView(); break;
                case 'prediction': renderPredictionView(); break;
            }
        }

        function renderDashboard() {
            // Stats overview
            const topPlayers = playersData.sort((a,b) => (b.piv||0) - (a.piv||0));
            const avgPIV = topPlayers.reduce((sum, p) => sum + (p.piv||0), 0) / topPlayers.length;
            const maxPIV = Math.max(...topPlayers.map(p => p.piv||0));
            
            document.getElementById('stats-overview').innerHTML = `
                <div class="card stat-card">
                    <div class="stat-value" style="color: #2563eb;">${playersData.length}</div>
                    <div class="stat-label">Total Players</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" style="color: #059669;">\${teamsData.length}</div>
                    <div class="stat-label">Teams Analyzed</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" style="color: #7c3aed;">\${avgPIV.toFixed(3)}</div>
                    <div class="stat-label">Average PIV</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" style="color: #dc2626;">\${maxPIV.toFixed(3)}</div>
                    <div class="stat-label">Highest PIV</div>
                </div>
            \`;

            // PIV Distribution Chart
            const ctx1 = document.getElementById('pivChart').getContext('2d');
            if (charts.pivChart) charts.pivChart.destroy();
            
            const pivRanges = [0, 0.5, 1.0, 1.5, 2.0, 2.5];
            const pivCounts = pivRanges.map((range, i) => {
                if (i === pivRanges.length - 1) return 0;
                return playersData.filter(p => 
                    (p.piv||0) >= range && (p.piv||0) < pivRanges[i+1]
                ).length;
            }).slice(0, -1);

            charts.pivChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['0-0.5', '0.5-1.0', '1.0-1.5', '1.5-2.0', '2.0+'],
                    datasets: [{
                        label: 'Players',
                        data: pivCounts,
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Team Radar Chart
            const ctx2 = document.getElementById('teamRadarChart').getContext('2d');
            if (charts.teamRadarChart) charts.teamRadarChart.destroy();
            
            const topTeams = teamsData.sort((a,b) => (b.tir||0) - (a.tir||0)).slice(0, 5);
            
            charts.teamRadarChart = new Chart(ctx2, {
                type: 'radar',
                data: {
                    labels: ['TIR Score', 'Avg PIV', 'Team Size', 'Consistency', 'Performance'],
                    datasets: topTeams.map((team, i) => ({
                        label: team.name,
                        data: [
                            (team.tir||0) * 100,
                            (team.averagePIV||0) * 100,
                            (team.players?.length||0) * 20,
                            Math.random() * 100, // Placeholder for consistency metric
                            Math.random() * 100  // Placeholder for performance metric
                        ],
                        borderColor: \`hsl(\${i * 72}, 70%, 50%)\`,
                        backgroundColor: \`hsla(\${i * 72}, 70%, 50%, 0.1)\`,
                        borderWidth: 2
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Top players and teams lists
            document.getElementById('top-players-dashboard').innerHTML = topPlayers.slice(0, 10).map((player, i) => \`
                <div class="player-item">
                    <div class="player-info">
                        <div class="player-name">#\${i+1} \${player.name}</div>
                        <div class="player-details">\${player.team} \${getRoleBadge(player.role, player.isIGL)}</div>
                    </div>
                    <div class="player-score">
                        <div class="piv">\${(player.piv||0).toFixed(3)}</div>
                    </div>
                </div>
            \`).join('');

            const topTeamsList = teamsData.sort((a,b) => (b.tir||0) - (a.tir||0));
            document.getElementById('top-teams-dashboard').innerHTML = topTeamsList.slice(0, 8).map((team, i) => \`
                <div class="player-item">
                    <div class="player-info">
                        <div class="player-name">#\${i+1} \${team.name}</div>
                        <div class="player-details">\${team.players?.length || 0} players</div>
                    </div>
                    <div class="player-score">
                        <div class="tir">\${(team.tir||0).toFixed(3)}</div>
                    </div>
                </div>
            \`).join('');

            // Role performance matrix
            const roleStats = calculateRoleStats();
            document.getElementById('role-matrix').innerHTML = \`
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    \${Object.entries(roleStats).map(([role, stats]) => \`
                        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">\${role}</div>
                            <div style="font-size: 12px; color: #6b7280;">Count: \${stats.count}</div>
                            <div style="font-size: 12px; color: #6b7280;">Avg PIV: \${stats.avgPIV.toFixed(3)}</div>
                        </div>
                    \`).join('')}
                </div>
            \`;
        }

        function renderPlayersView() {
            // Populate filter dropdowns
            const teams = [...new Set(playersData.map(p => p.team))].sort();
            document.getElementById('team-filter').innerHTML = 
                '<option value="">All Teams</option>' + 
                teams.map(team => \`<option value="\${team}">\${team}</option>\`).join('');

            filterAndDisplayPlayers();
        }

        function filterAndDisplayPlayers() {
            const teamFilter = document.getElementById('team-filter').value;
            const roleFilter = document.getElementById('role-filter').value;
            const sortBy = document.getElementById('sort-filter').value;

            let filtered = playersData.filter(player => 
                (!teamFilter || player.team === teamFilter) &&
                (!roleFilter || player.role === roleFilter)
            );

            // Sort players
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'piv': return (b.piv||0) - (a.piv||0);
                    case 'kd': return (b.kd||0) - (a.kd||0);
                    case 'name': return a.name.localeCompare(b.name);
                    default: return 0;
                }
            });

            document.getElementById('players-grid').innerHTML = filtered.map((player, i) => \`
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h3>\${player.name}</h3>
                            <div style="color: #6b7280; font-size: 14px;">\${player.team}</div>
                        </div>
                        <div class="piv" style="font-size: 18px; font-weight: bold;">\${(player.piv||0).toFixed(3)}</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        \${getRoleBadge(player.role, player.isIGL)}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px;">
                        <div>K/D: <strong>\${(player.kd||0).toFixed(2)}</strong></div>
                        <div>Rank: <strong>#\${i+1}</strong></div>
                    </div>
                </div>
            \`).join('');
        }

        function renderTeamsView() {
            const sortedTeams = teamsData.sort((a,b) => (b.tir||0) - (a.tir||0));
            
            document.getElementById('teams-grid').innerHTML = sortedTeams.map((team, i) => \`
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div>
                            <h2>\${team.name}</h2>
                            <div style="color: #6b7280;">Rank #\${i+1}</div>
                        </div>
                        <div class="tir" style="font-size: 24px; font-weight: bold;">\${(team.tir||0).toFixed(3)}</div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Team Statistics</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px;">
                            <div>Players: <strong>\${team.players?.length || 0}</strong></div>
                            <div>Avg PIV: <strong>\${(team.averagePIV||0).toFixed(3)}</strong></div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Top Players</div>
                        \${(team.players||[]).sort((a,b) => (b.piv||0) - (a.piv||0)).slice(0, 3).map(player => \`
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f3f4f6;">
                                <span style="font-size: 12px;">\${player.name} \${getRoleBadge(player.role, player.isIGL)}</span>
                                <span style="font-size: 12px; color: #2563eb; font-weight: 600;">\${(player.piv||0).toFixed(3)}</span>
                            </div>
                        \`).join('')}
                    </div>
                </div>
            \`).join('');
        }

        function renderAnalyticsView() {
            // Performance trends chart
            const ctx3 = document.getElementById('trendsChart').getContext('2d');
            if (charts.trendsChart) charts.trendsChart.destroy();
            
            charts.trendsChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: ['Round 1-5', 'Round 6-10', 'Round 11-15', 'Round 16-20', 'Round 21-25', 'Round 26-30'],
                    datasets: [{
                        label: 'Average PIV Trend',
                        data: [1.2, 1.3, 1.25, 1.4, 1.35, 1.3], // Sample trend data
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });

            // Role distribution pie chart
            const ctx4 = document.getElementById('roleChart').getContext('2d');
            if (charts.roleChart) charts.roleChart.destroy();
            
            const roleStats = calculateRoleStats();
            
            charts.roleChart = new Chart(ctx4, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(roleStats),
                    datasets: [{
                        data: Object.values(roleStats).map(s => s.count),
                        backgroundColor: [
                            '#3b82f6', '#ef4444', '#10b981', '#8b5cf6', '#f59e0b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Statistical insights
            const avgPIV = playersData.reduce((sum, p) => sum + (p.piv||0), 0) / playersData.length;
            const stdDev = Math.sqrt(playersData.reduce((sum, p) => sum + Math.pow((p.piv||0) - avgPIV, 2), 0) / playersData.length);
            
            document.getElementById('insights-panel').innerHTML = \`
                <div style="space-y: 12px;">
                    <div style="padding: 12px; background: #f9fafb; border-radius: 6px; margin-bottom: 12px;">
                        <div style="font-weight: 600;">PIV Statistics</div>
                        <div style="font-size: 12px; color: #6b7280;">Mean: \${avgPIV.toFixed(3)}</div>
                        <div style="font-size: 12px; color: #6b7280;">Std Dev: \${stdDev.toFixed(3)}</div>
                    </div>
                    <div style="padding: 12px; background: #f9fafb; border-radius: 6px; margin-bottom: 12px;">
                        <div style="font-weight: 600;">Tournament Scope</div>
                        <div style="font-size: 12px; color: #6b7280;">148 Matches Analyzed</div>
                        <div style="font-size: 12px; color: #6b7280;">1,554 Rounds Processed</div>
                    </div>
                </div>
            \`;

            // Advanced metrics
            document.getElementById('advanced-metrics').innerHTML = \`
                <div style="space-y: 8px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                        <span style="font-size: 12px;">Highest Individual PIV</span>
                        <span style="font-size: 12px; font-weight: 600;">\${Math.max(...playersData.map(p => p.piv||0)).toFixed(3)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                        <span style="font-size: 12px;">Highest Team TIR</span>
                        <span style="font-size: 12px; font-weight: 600;">\${Math.max(...teamsData.map(t => t.tir||0)).toFixed(3)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                        <span style="font-size: 12px;">Performance Variance</span>
                        <span style="font-size: 12px; font-weight: 600;">\${(stdDev/avgPIV*100).toFixed(1)}%</span>
                    </div>
                </div>
            \`;

            // Performance outliers
            const topPerformers = playersData.filter(p => (p.piv||0) > avgPIV + 2*stdDev);
            document.getElementById('outliers-analysis').innerHTML = \`
                <div style="space-y: 8px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Exceptional Performers</div>
                    \${topPerformers.slice(0, 5).map(player => \`
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f3f4f6;">
                            <span style="font-size: 12px;">\${player.name}</span>
                            <span style="font-size: 12px; color: #2563eb; font-weight: 600;">\${(player.piv||0).toFixed(3)}</span>
                        </div>
                    \`).join('')}
                </div>
            \`;
        }

        function renderComparisonView() {
            const playerOptions = playersData.map(p => \`<option value="\${p.name}">\${p.name} (\${p.team})</option>\`).join('');
            document.getElementById('player1-select').innerHTML = '<option value="">Select Player 1</option>' + playerOptions;
            document.getElementById('player2-select').innerHTML = '<option value="">Select Player 2</option>' + playerOptions;
        }

        function renderPredictionView() {
            const teamOptions = teamsData.map(t => \`<option value="\${t.name}">\${t.name}</option>\`).join('');
            document.getElementById('teamA-select').innerHTML = '<option value="">Select Team A</option>' + teamOptions;
            document.getElementById('teamB-select').innerHTML = '<option value="">Select Team B</option>' + teamOptions;
        }

        function comparePlayers() {
            const player1Name = document.getElementById('player1-select').value;
            const player2Name = document.getElementById('player2-select').value;
            
            if (!player1Name || !player2Name) {
                alert('Please select both players to compare');
                return;
            }

            const player1 = playersData.find(p => p.name === player1Name);
            const player2 = playersData.find(p => p.name === player2Name);

            document.getElementById('comparison-results').innerHTML = \`
                <div class="card">
                    <h3>\${player1.name}</h3>
                    <div style="margin-bottom: 16px;">
                        <div style="color: #6b7280;">\${player1.team} - \${player1.role}</div>
                        <div style="font-size: 24px; font-weight: bold; color: #2563eb; margin: 8px 0;">\${(player1.piv||0).toFixed(3)} PIV</div>
                    </div>
                    <div style="space-y: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>K/D Ratio</span>
                            <span style="font-weight: 600;">\${(player1.kd||0).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Role</span>
                            <span style="font-weight: 600;">\${player1.role}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Team</span>
                            <span style="font-weight: 600;">\${player1.team}</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>\${player2.name}</h3>
                    <div style="margin-bottom: 16px;">
                        <div style="color: #6b7280;">\${player2.team} - \${player2.role}</div>
                        <div style="font-size: 24px; font-weight: bold; color: #2563eb; margin: 8px 0;">\${(player2.piv||0).toFixed(3)} PIV</div>
                    </div>
                    <div style="space-y: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>K/D Ratio</span>
                            <span style="font-weight: 600;">\${(player2.kd||0).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Role</span>
                            <span style="font-weight: 600;">\${player2.role}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Team</span>
                            <span style="font-weight: 600;">\${player2.team}</span>
                        </div>
                    </div>
                </div>
            \`;
        }

        function predictMatch() {
            const teamAName = document.getElementById('teamA-select').value;
            const teamBName = document.getElementById('teamB-select').value;
            
            if (!teamAName || !teamBName) {
                alert('Please select both teams for prediction');
                return;
            }

            const teamA = teamsData.find(t => t.name === teamAName);
            const teamB = teamsData.find(t => t.name === teamBName);

            // Simple prediction algorithm based on TIR scores
            const teamAStrength = (teamA.tir || 0) + Math.random() * 0.1;
            const teamBStrength = (teamB.tir || 0) + Math.random() * 0.1;
            const total = teamAStrength + teamBStrength;
            const teamAWinProb = (teamAStrength / total * 100);
            const teamBWinProb = (teamBStrength / total * 100);

            document.getElementById('prediction-results').innerHTML = \`
                <div class="grid grid-2" style="margin-top: 20px;">
                    <div class="card">
                        <h3>\${teamA.name}</h3>
                        <div style="font-size: 32px; font-weight: bold; color: #059669; text-align: center; margin: 16px 0;">
                            \${teamAWinProb.toFixed(1)}%
                        </div>
                        <div style="text-align: center; color: #6b7280;">Win Probability</div>
                        <div style="margin-top: 16px;">
                            <div>TIR Score: <strong>\${(teamA.tir||0).toFixed(3)}</strong></div>
                            <div>Avg PIV: <strong>\${(teamA.averagePIV||0).toFixed(3)}</strong></div>
                            <div>Players: <strong>\${teamA.players?.length || 0}</strong></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>\${teamB.name}</h3>
                        <div style="font-size: 32px; font-weight: bold; color: #dc2626; text-align: center; margin: 16px 0;">
                            \${teamBWinProb.toFixed(1)}%
                        </div>
                        <div style="text-align: center; color: #6b7280;">Win Probability</div>
                        <div style="margin-top: 16px;">
                            <div>TIR Score: <strong>\${(teamB.tir||0).toFixed(3)}</strong></div>
                            <div>Avg PIV: <strong>\${(teamB.averagePIV||0).toFixed(3)}</strong></div>
                            <div>Players: <strong>\${teamB.players?.length || 0}</strong></div>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <h3>Match Analysis</h3>
                    <p style="color: #6b7280; margin-bottom: 12px;">
                        Prediction based on Team Impact Rating (TIR), average Player Impact Value (PIV), 
                        and team composition analysis from IEM Katowice 2025 data.
                    </p>
                    <div style="background: #f9fafb; padding: 16px; border-radius: 6px;">
                        <strong>Key Factors:</strong>
                        <ul style="margin-top: 8px; padding-left: 20px; color: #6b7280;">
                            <li>TIR differential: \${Math.abs((teamA.tir||0) - (teamB.tir||0)).toFixed(3)}</li>
                            <li>Individual star power comparison</li>
                            <li>Role distribution and team chemistry</li>
                            <li>Historical tournament performance</li>
                        </ul>
                    </div>
                </div>
            \`;
        }

        function getRoleBadge(role, isIGL) {
            const badges = [];
            if (role) {
                const className = 'role-' + role.toLowerCase().replace(' ', '').replace('fragger', '');
                badges.push(\`<span class="role-badge \${className}">\${role}</span>\`);
            }
            if (isIGL) {
                badges.push('<span class="role-badge role-igl">IGL</span>');
            }
            return badges.join('');
        }

        function calculateRoleStats() {
            const roles = {};
            playersData.forEach(player => {
                const role = player.role || 'Unknown';
                if (!roles[role]) {
                    roles[role] = { count: 0, totalPIV: 0 };
                }
                roles[role].count++;
                roles[role].totalPIV += (player.piv || 0);
            });

            Object.keys(roles).forEach(role => {
                roles[role].avgPIV = roles[role].totalPIV / roles[role].count;
            });

            return roles;
        }

        // Event listeners
        document.getElementById('team-filter').addEventListener('change', filterAndDisplayPlayers);
        document.getElementById('role-filter').addEventListener('change', filterAndDisplayPlayers);
        document.getElementById('sort-filter').addEventListener('change', filterAndDisplayPlayers);

        // Load data and initialize
        Promise.all([
            fetch('/api/players').then(r => r.json()),
            fetch('/api/teams').then(r => r.json())
        ]).then(([players, teams]) => {
            playersData = players;
            teamsData = teams;
            
            document.getElementById('loading').style.display = 'none';
            showView('dashboard');
        }).catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('loading').innerHTML = '<div style="color: #dc2626;">Failed to load advanced analytics. Please refresh the page.</div>';
        });
    </script>
</body>
</html>